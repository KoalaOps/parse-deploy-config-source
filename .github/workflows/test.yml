name: Test Parse Deploy Config Source

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    name: Test parsing examples
    
    steps:
      - uses: actions/checkout@v4
      
      # Test 1: Empty string (all defaults)
      - name: Test empty string
        id: test1
        uses: ./
        with:
          source: ""
      
      - name: Validate empty string
        run: |
          echo "Test 1: Empty string"
          echo "Repository: ${{ steps.test1.outputs.repository }}"
          echo "Ref: ${{ steps.test1.outputs.ref }}"
          echo "Path: ${{ steps.test1.outputs.path }}"
          echo "Is self: ${{ steps.test1.outputs.is_self }}"
          
          # Validate outputs
          [[ "${{ steps.test1.outputs.repository }}" == "${{ github.repository }}" ]] || exit 1
          [[ "${{ steps.test1.outputs.ref }}" == "${{ github.ref }}" ]] || exit 1
          [[ "${{ steps.test1.outputs.path }}" == "." ]] || exit 1
          [[ "${{ steps.test1.outputs.is_self }}" == "true" ]] || exit 1
      
      # Test 2: Explicit self
      - name: Test self
        id: test2
        uses: ./
        with:
          source: "self"
      
      - name: Validate self
        run: |
          echo "Test 2: self"
          echo "Repository: ${{ steps.test2.outputs.repository }}"
          echo "Ref: ${{ steps.test2.outputs.ref }}"
          echo "Path: ${{ steps.test2.outputs.path }}"
          echo "Is self: ${{ steps.test2.outputs.is_self }}"
          
          [[ "${{ steps.test2.outputs.repository }}" == "${{ github.repository }}" ]] || exit 1
          [[ "${{ steps.test2.outputs.ref }}" == "${{ github.ref }}" ]] || exit 1
          [[ "${{ steps.test2.outputs.path }}" == "." ]] || exit 1
          [[ "${{ steps.test2.outputs.is_self }}" == "true" ]] || exit 1
      
      # Test 3: Ref only
      - name: Test @main
        id: test3
        uses: ./
        with:
          source: "@main"
      
      - name: Validate @main
        run: |
          echo "Test 3: @main"
          echo "Repository: ${{ steps.test3.outputs.repository }}"
          echo "Ref: ${{ steps.test3.outputs.ref }}"
          echo "Path: ${{ steps.test3.outputs.path }}"
          echo "Is self: ${{ steps.test3.outputs.is_self }}"
          
          [[ "${{ steps.test3.outputs.repository }}" == "${{ github.repository }}" ]] || exit 1
          [[ "${{ steps.test3.outputs.ref }}" == "main" ]] || exit 1
          [[ "${{ steps.test3.outputs.path }}" == "." ]] || exit 1
          [[ "${{ steps.test3.outputs.is_self }}" == "true" ]] || exit 1
      
      # Test 4: Path only
      - name: Test :services/api
        id: test4
        uses: ./
        with:
          source: ":services/api"
      
      - name: Validate :services/api
        run: |
          echo "Test 4: :services/api"
          echo "Repository: ${{ steps.test4.outputs.repository }}"
          echo "Ref: ${{ steps.test4.outputs.ref }}"
          echo "Path: ${{ steps.test4.outputs.path }}"
          echo "Is self: ${{ steps.test4.outputs.is_self }}"
          
          [[ "${{ steps.test4.outputs.repository }}" == "${{ github.repository }}" ]] || exit 1
          [[ "${{ steps.test4.outputs.ref }}" == "${{ github.ref }}" ]] || exit 1
          [[ "${{ steps.test4.outputs.path }}" == "services/api" ]] || exit 1
          [[ "${{ steps.test4.outputs.is_self }}" == "true" ]] || exit 1
      
      # Test 5: Ref and path
      - name: Test @main:services/api
        id: test5
        uses: ./
        with:
          source: "@main:services/api"
      
      - name: Validate @main:services/api
        run: |
          echo "Test 5: @main:services/api"
          echo "Repository: ${{ steps.test5.outputs.repository }}"
          echo "Ref: ${{ steps.test5.outputs.ref }}"
          echo "Path: ${{ steps.test5.outputs.path }}"
          echo "Is self: ${{ steps.test5.outputs.is_self }}"
          
          [[ "${{ steps.test5.outputs.repository }}" == "${{ github.repository }}" ]] || exit 1
          [[ "${{ steps.test5.outputs.ref }}" == "main" ]] || exit 1
          [[ "${{ steps.test5.outputs.path }}" == "services/api" ]] || exit 1
          [[ "${{ steps.test5.outputs.is_self }}" == "true" ]] || exit 1
      
      # Test 6: self:services/api
      - name: Test self:services/api
        id: test6
        uses: ./
        with:
          source: "self:services/api"
      
      - name: Validate self:services/api
        run: |
          echo "Test 6: self:services/api"
          echo "Repository: ${{ steps.test6.outputs.repository }}"
          echo "Ref: ${{ steps.test6.outputs.ref }}"
          echo "Path: ${{ steps.test6.outputs.path }}"
          echo "Is self: ${{ steps.test6.outputs.is_self }}"
          
          [[ "${{ steps.test6.outputs.repository }}" == "${{ github.repository }}" ]] || exit 1
          [[ "${{ steps.test6.outputs.ref }}" == "${{ github.ref }}" ]] || exit 1
          [[ "${{ steps.test6.outputs.path }}" == "services/api" ]] || exit 1
          [[ "${{ steps.test6.outputs.is_self }}" == "true" ]] || exit 1
      
      # Test 7: External repo
      - name: Test Acme/configs
        id: test7
        uses: ./
        with:
          source: "Acme/configs"
      
      - name: Validate Acme/configs
        run: |
          echo "Test 7: Acme/configs"
          echo "Repository: ${{ steps.test7.outputs.repository }}"
          echo "Ref: ${{ steps.test7.outputs.ref }}"
          echo "Path: ${{ steps.test7.outputs.path }}"
          echo "Is self: ${{ steps.test7.outputs.is_self }}"
          
          [[ "${{ steps.test7.outputs.repository }}" == "Acme/configs" ]] || exit 1
          [[ "${{ steps.test7.outputs.ref }}" == "" ]] || exit 1
          [[ "${{ steps.test7.outputs.path }}" == "." ]] || exit 1
          [[ "${{ steps.test7.outputs.is_self }}" == "false" ]] || exit 1
      
      # Test 8: External repo with tag
      - name: Test Acme/configs@v1.2.3
        id: test8
        uses: ./
        with:
          source: "Acme/configs@v1.2.3"
      
      - name: Validate Acme/configs@v1.2.3
        run: |
          echo "Test 8: Acme/configs@v1.2.3"
          echo "Repository: ${{ steps.test8.outputs.repository }}"
          echo "Ref: ${{ steps.test8.outputs.ref }}"
          echo "Path: ${{ steps.test8.outputs.path }}"
          echo "Is self: ${{ steps.test8.outputs.is_self }}"
          
          [[ "${{ steps.test8.outputs.repository }}" == "Acme/configs" ]] || exit 1
          [[ "${{ steps.test8.outputs.ref }}" == "v1.2.3" ]] || exit 1
          [[ "${{ steps.test8.outputs.path }}" == "." ]] || exit 1
          [[ "${{ steps.test8.outputs.is_self }}" == "false" ]] || exit 1
      
      # Test 9: External repo with path
      - name: Test Acme/configs:services/api
        id: test9
        uses: ./
        with:
          source: "Acme/configs:services/api"
      
      - name: Validate Acme/configs:services/api
        run: |
          echo "Test 9: Acme/configs:services/api"
          echo "Repository: ${{ steps.test9.outputs.repository }}"
          echo "Ref: ${{ steps.test9.outputs.ref }}"
          echo "Path: ${{ steps.test9.outputs.path }}"
          echo "Is self: ${{ steps.test9.outputs.is_self }}"
          
          [[ "${{ steps.test9.outputs.repository }}" == "Acme/configs" ]] || exit 1
          [[ "${{ steps.test9.outputs.ref }}" == "" ]] || exit 1
          [[ "${{ steps.test9.outputs.path }}" == "services/api" ]] || exit 1
          [[ "${{ steps.test9.outputs.is_self }}" == "false" ]] || exit 1
      
      # Test 10: Full specification
      - name: Test Acme/configs@main:services/api
        id: test10
        uses: ./
        with:
          source: "Acme/configs@main:services/api"
      
      - name: Validate Acme/configs@main:services/api
        run: |
          echo "Test 10: Acme/configs@main:services/api"
          echo "Repository: ${{ steps.test10.outputs.repository }}"
          echo "Ref: ${{ steps.test10.outputs.ref }}"
          echo "Path: ${{ steps.test10.outputs.path }}"
          echo "Is self: ${{ steps.test10.outputs.is_self }}"
          
          [[ "${{ steps.test10.outputs.repository }}" == "Acme/configs" ]] || exit 1
          [[ "${{ steps.test10.outputs.ref }}" == "main" ]] || exit 1
          [[ "${{ steps.test10.outputs.path }}" == "services/api" ]] || exit 1
          [[ "${{ steps.test10.outputs.is_self }}" == "false" ]] || exit 1
      
      # Test 11: Path cleanup (leading/trailing slashes)
      - name: Test path cleanup
        id: test11
        uses: ./
        with:
          source: "self:/services/api/"
      
      - name: Validate path cleanup
        run: |
          echo "Test 11: Path cleanup"
          echo "Repository: ${{ steps.test11.outputs.repository }}"
          echo "Path: ${{ steps.test11.outputs.path }}"
          
          [[ "${{ steps.test11.outputs.path }}" == "services/api" ]] || exit 1
      
      # Test 12: Complex path with multiple segments
      - name: Test complex path
        id: test12
        uses: ./
        with:
          source: "Acme/deployments@feature/test-123:platform/payments/service"
      
      - name: Validate complex path
        run: |
          echo "Test 12: Complex path"
          echo "Repository: ${{ steps.test12.outputs.repository }}"
          echo "Ref: ${{ steps.test12.outputs.ref }}"
          echo "Path: ${{ steps.test12.outputs.path }}"
          
          [[ "${{ steps.test12.outputs.repository }}" == "Acme/deployments" ]] || exit 1
          [[ "${{ steps.test12.outputs.ref }}" == "feature/test-123" ]] || exit 1
          [[ "${{ steps.test12.outputs.path }}" == "platform/payments/service" ]] || exit 1
      
      # Test 13: With environment - test overlay_dir output
      - name: Test with environment (prod)
        id: test13
        uses: ./
        with:
          source: "self"
          environment: "prod"

      - name: Validate with environment
        run: |
          echo "Test 13: With environment"
          echo "Repository: ${{ steps.test13.outputs.repository }}"
          echo "Path: ${{ steps.test13.outputs.path }}"
          echo "Overlay dir: ${{ steps.test13.outputs.overlay_dir }}"
          echo "Is separate deploy repo: ${{ steps.test13.outputs.is_separate_deploy_repo }}"

          [[ "${{ steps.test13.outputs.overlay_dir }}" == "deploy/overlays/prod" ]] || exit 1
          [[ "${{ steps.test13.outputs.is_separate_deploy_repo }}" == "false" ]] || exit 1

      # Test 14: With environment and path
      - name: Test with environment and path
        id: test14
        uses: ./
        with:
          source: ":services/api"
          environment: "staging"

      - name: Validate with environment and path
        run: |
          echo "Test 14: With environment and path"
          echo "Path: ${{ steps.test14.outputs.path }}"
          echo "Overlay dir: ${{ steps.test14.outputs.overlay_dir }}"

          [[ "${{ steps.test14.outputs.overlay_dir }}" == "services/api/deploy/overlays/staging" ]] || exit 1

      # Test 15: Without environment - overlay_dir should be empty
      - name: Test without environment
        id: test15
        uses: ./
        with:
          source: "self:services/api"

      - name: Validate without environment
        run: |
          echo "Test 15: Without environment"
          echo "Path: ${{ steps.test15.outputs.path }}"
          echo "Overlay dir: '${{ steps.test15.outputs.overlay_dir }}'"

          [[ -z "${{ steps.test15.outputs.overlay_dir }}" ]] || exit 1

      # Test 16: External repo - is_separate_deploy_repo should be true
      - name: Test external repo deploy flag
        id: test16
        uses: ./
        with:
          source: "Acme/configs"
          environment: "dev"

      - name: Validate external repo deploy flag
        run: |
          echo "Test 16: External repo deploy flag"
          echo "Repository: ${{ steps.test16.outputs.repository }}"
          echo "Is separate deploy repo: ${{ steps.test16.outputs.is_separate_deploy_repo }}"
          echo "Overlay dir: ${{ steps.test16.outputs.overlay_dir }}"

          [[ "${{ steps.test16.outputs.is_separate_deploy_repo }}" == "true" ]] || exit 1
          [[ "${{ steps.test16.outputs.overlay_dir }}" == "deploy/overlays/dev" ]] || exit 1

      # Test 17: External repo with path and environment
      - name: Test external repo with path and environment
        id: test17
        uses: ./
        with:
          source: "Acme/configs@main:platform/services"
          environment: "qa"

      - name: Validate external repo with path and environment
        run: |
          echo "Test 17: External repo with path and environment"
          echo "Repository: ${{ steps.test17.outputs.repository }}"
          echo "Path: ${{ steps.test17.outputs.path }}"
          echo "Overlay dir: ${{ steps.test17.outputs.overlay_dir }}"
          echo "Is separate deploy repo: ${{ steps.test17.outputs.is_separate_deploy_repo }}"

          [[ "${{ steps.test17.outputs.overlay_dir }}" == "platform/services/deploy/overlays/qa" ]] || exit 1
          [[ "${{ steps.test17.outputs.is_separate_deploy_repo }}" == "true" ]] || exit 1

      - name: Summary
        run: |
          echo "✅ All tests passed!"
          echo ""
          echo "Tested scenarios:"
          echo "- Empty string (all defaults)"
          echo "- Explicit self"
          echo "- Ref only (@main)"
          echo "- Path only (:services/api)"
          echo "- Ref and path (@main:services/api)"
          echo "- Repo and path (self:services/api)"
          echo "- External repo"
          echo "- External repo with tag"
          echo "- External repo with path"
          echo "- Full specification"
          echo "- Path cleanup"
          echo "- Complex paths and refs"
          echo "- With environment (overlay_dir output)"
          echo "- With environment and path"
          echo "- Without environment (no overlay_dir)"
          echo "- External repo (is_separate_deploy_repo true)"
          echo "- External repo with path and environment"